To copy important files to AWS, run the following commands from the wiretap-server root directory.
Locally, run `sudo pnpm run build`

Production:
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem ./package.json ubuntu@34.203.76.152:/home/ubuntu/wiretap
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem ./pnpm-lock.yaml ubuntu@34.203.76.152:/home/ubuntu/wiretap
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem ./.env.production ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src/.env.production
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem ./ecosystem.config.js ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/index.js ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/classes ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/controllers ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/db-operations ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/middleware ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/prisma ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/routes ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/types ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./dist/src/utils ubuntu@34.203.76.152:/home/ubuntu/wiretap/dist/src
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem -r ./prisma ubuntu@34.203.76.152:/home/ubuntu/wiretap/
	scp -i /Users/arieltamayev/Documents/wiretap-production-ec2-keypair.pem ./prisma.config.ts ubuntu@34.203.76.152:/home/ubuntu/wiretap/

To SSH into AWS:
	aws ec2-instance-connect ssh --instance-id i-0af414ad7e5d89c3e --os-user ubuntu

For Database migrations, navigate to /wiretap, and run:
	pnpm dlx prisma migrate deploy && pnpm dlx prisma generate && pm2 restart 0 && pm2 logs;
	If nothing is working after doing a migration, try restarting the pm2 `pm2 restart 0`
	If there is new data to seed, run `pnpm run cloud-seed`

Shortcuts:
	Restart server after application update:
		cd wiretap/ && pnpm i --prod && pm2 restart 0 && pm2 logs;
	DB (be in /wiretap folder)
		pnpm dlx prisma migrate deploy && pnpm dlx prisma generate && pm2 restart 0 && pm2 logs;

Other:
- If getting this error:  `Error: @prisma/client did not initialize yet. Please run "prisma generate" and try to import it again.`, run:
	`npx prisma generate` in the src directory
- If getting this error after a migration: `Unknown field `[field_name]` for select statement on model [model_name]...`
	Check that the field exists in PGAdmin (remote into the RDS box). If it does, run `npx prisma generate` in the src directory
- To save the Postgres Url to AWS's configuration, go into `nano ~/.bashrc`, to the end of the file, and add:
	export DATABASE_URL='your-database-url'.
	Save, and run `source ~/.bashrc`
	Run `echo $DATABASE_URL` to make sure the command ran correctly

- Update linux packages
	sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y

Periodically locally run `depcheck` to see if any packages aren't being used

When first settings up the server, create a wiretap folder, and a dist folder inside of it, and a src folder inside of that.

Deleting an active instance:
	1. Stop the instance:
		pm2 stop all
		pm2 delete all
		pm2 save --force
	2. Delete the instance:
		rm -rf /home/ubuntu/wiretap
	3. npm cache clean --force
	4. sudo npm uninstall -g pnpm

Setting up a new instance:
	1. Install node:
		curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
		source ~/.bashrc
		nvm install --lts
		nvm use --lts
	2. Install pm2:
		npm install -g pm2
	3. Install pnpm:
		curl -fsSL https://get.pnpm.io/install.sh | sh -
		source ~/.bashrc
	4. Make directories:
		mkdir -p /home/ubuntu/wiretap
		mkdir -p /home/ubuntu/wiretap/dist/src
	4.5. Transfer files to the instance (above)
	5. Go to the wiretap directory:
		cd /home/ubuntu/wiretap
		pnpm install --prod --frozen-lockfile
		pnpm dlx prisma migrate deploy && pnpm dlx prisma generate
		pnpm run cloud-seed
	6. Go to /wiretap/dist/src:
		cd /home/ubuntu/wiretap/dist/src
		pm2 start ecosystem.config.js --env production
	7. View logs:
		pm2 logs
