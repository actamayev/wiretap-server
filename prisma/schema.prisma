generator client {
	provider = "prisma-client"
	output = "../src/generated/prisma"  // Required now
  	moduleFormat = "cjs"                // Keep CommonJS
}

datasource db {
	provider = "postgresql"
}

enum AuthMethods {
	WIRETAP
	GOOGLE
}

model credentials {
	user_id                                                     Int      @id @default(autoincrement())
	username                                                    String?     @unique

	password                                                    String?
	is_active                                                   Boolean  @default(true)

	auth_method                                                 AuthMethods

	email__encrypted                                            String @unique

	created_at                                                  DateTime @default(now())
	updated_at                                                  DateTime @default(now()) @updatedAt

	login_history                                               login_history[]
	wiretap_fund												wiretap_fund[]
	user_feedback												user_feedback[]
}

model login_history {
	login_history_id                                            Int       @id @default(autoincrement())
	user_id                                                     Int
	login_time                                                  DateTime  @default(now())

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	@@index([user_id], name: "login_history__user_id_idx")
}

model email_update_subscriber {
	email_update_subscriber_id									Int       @id @default(autoincrement())
	email__encrypted                                            String @unique

	created_at                                                  DateTime  @default(now())
}

model wiretap_fund {
	wiretap_fund_uuid                               	 		String		@id
	user_id                                                     Int

	fund_name													String
	starting_account_balance_usd								Float
	current_account_balance_usd									Float
	is_primary_fund												Boolean		@default(false)
	is_starting_fund											Boolean		@default(false)

	created_at                                                  DateTime     @default(now())
	updated_at                                                  DateTime     @default(now()) @updatedAt

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	purchase_orders												purchase_order[]
	sales_orders												sale_order[]
	positions													position[]
	portfolio_snapshot											portfolio_snapshot[]
}

// Events table - one row per event
model polymarket_event {
	event_id                    								String    @id
	title                       								String
	description                 								String
	event_slug													String @unique

	// Market status
	active                      								Boolean   @default(true)
	closed                      								Boolean   @default(false)
	archived                    								Boolean   @default(false)

	// Resolution data
	resolved                    								Boolean   @default(false)
	resolution_time             								DateTime?

	// Metadata
	start_date                  								DateTime?
	end_date                    								DateTime?

	// Event-level financials (aggregated across all markets)
	total_volume                      							Float?

	polymarket_url              								String
	image_url                   								String?
	icon_url                    								String?

	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	markets                     								polymarket_market[]
}

// Markets table - one row per condition_id (the tradeable market itself)
model polymarket_market {
	market_id                   								Int       @id @default(autoincrement())
	condition_id                								String    @unique // Polymarket's condition ID
	event_id                    								String

	question                    								String?    // The market question

	// Market-level metadata
	active                      								Boolean   @default(true)
	closed                      								Boolean   @default(false)
	accepting_orders            								Boolean   @default(true)

	// Aggregate market data (often reflects primary outcome in API)
	last_trade_price            								Float?

	// Volume metrics (market-level)
	volume                      								Float?
	volume_total												Float?

	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	event                       								polymarket_event @relation(fields: [event_id], references: [event_id])
	outcomes                    								polymarket_outcome[]

	@@index([event_id])
}

// Outcomes table - one row per tradeable outcome token
model polymarket_outcome {
	outcome_id                  								Int       @id @default(autoincrement())
	market_id                   								Int

	clob_token_id               								String    @unique // The specific tradeable token ID
	outcome                     								String    // "Yes", "No", "Trump", "Harris", etc
	outcome_index               								Int       // Position in outcomes array (0, 1, 2...)

	// Outcome-specific pricing
	current_price               								Float?    // From outcomePrices array

	// Resolution
	winning_outcome             								Boolean   @default(false)
	payout_per_share            								Float?    // 1.0 if won, 0.0 if lost

	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	market                      								polymarket_market @relation(fields: [market_id], references: [market_id], onDelete: Cascade)

	purchase_orders             								purchase_order[]
	sale_orders                 								sale_order[]
	positions                   								position[]

	@@unique([market_id, outcome_index])
	@@index([market_id])
	@@index([clob_token_id])
}

// Position - references specific outcome
model position {
	position_id                 								Int       @id @default(autoincrement())
	outcome_id                  								Int

	number_contracts_held       								Float
	average_cost_per_contract   								Float
	total_cost                  								Float

	wiretap_fund_uuid 											String
	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	wiretap_fund   												wiretap_fund @relation(fields: [wiretap_fund_uuid], references: [wiretap_fund_uuid])
	outcome                     								polymarket_outcome @relation(fields: [outcome_id], references: [outcome_id])

	@@unique([wiretap_fund_uuid, outcome_id])
	@@index([wiretap_fund_uuid])
}

// Purchase order - references specific outcome
model purchase_order {
	purchase_id                 								Int       @id @default(autoincrement())
	outcome_id                  								Int

	number_of_contracts         								Float
	price_per_contract          								Float
	total_cost                  								Float

	// Snapshot of market state at execution
	market_best_bid             								Float?
	market_best_ask             								Float?

	wiretap_fund_uuid 											String

	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	wiretap_fund   												wiretap_fund @relation(fields: [wiretap_fund_uuid], references: [wiretap_fund_uuid])
	outcome                     								polymarket_outcome @relation(fields: [outcome_id], references: [outcome_id])

	@@index([wiretap_fund_uuid])
	@@index([outcome_id])
}

// Sale order - references specific outcome
model sale_order {
	sale_id                     								Int       @id @default(autoincrement())
	outcome_id                  								Int

	number_of_contracts         								Float
	price_per_contract          								Float
	total_proceeds              								Float
	realized_pnl                								Float

	// Snapshot of market state at execution
	market_best_bid             								Float?
	market_best_ask             								Float?

	wiretap_fund_uuid 											String

	created_at                  								DateTime  @default(now())
	updated_at                  								DateTime  @default(now()) @updatedAt

	wiretap_fund   												wiretap_fund @relation(fields: [wiretap_fund_uuid], references: [wiretap_fund_uuid])
	outcome                     								polymarket_outcome @relation(fields: [outcome_id], references: [outcome_id])

	@@index([wiretap_fund_uuid])
	@@index([outcome_id])
}

model portfolio_snapshot {
	snapshot_id    												Int      @id @default(autoincrement())
	wiretap_fund_uuid 											String
	total_value    												Float
	timestamp      												DateTime @default(now())

	wiretap_fund   												wiretap_fund @relation(fields: [wiretap_fund_uuid], references: [wiretap_fund_uuid])

	@@unique([wiretap_fund_uuid, timestamp])
	@@index([wiretap_fund_uuid])
	@@index([timestamp])
}

model user_feedback {
	user_feedback_id                                            Int       @id @default(autoincrement())
	user_id                                                     Int
	feedback                                                    String

	created_at                                                  DateTime  @default(now())

	user                                                        credentials @relation(fields: [user_id], references: [user_id])

	@@index([user_id])
}
